<!DOCTYPE html>
<html lang="es" data-theme="auto">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Calculadora de carrera — PWA</title>

  <!-- Colores del navegador (light/dark + fallback) -->
  <meta name="theme-color" content="#22c55e" media="(prefers-color-scheme: light)">
  <meta name="theme-color" content="#0f172a" media="(prefers-color-scheme: dark)">
  <meta name="msapplication-TileColor" content="#0f172a">

  <!-- PWA: manifest generado dinámicamente con iconos maskable -->
  <link id="manifestLink" rel="manifest">
  <!-- iOS requiere apple-touch-icon con fichero físico -->
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png" sizes="180x180">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="CarreraCalc">

  <style>
    :root{
      --bg:#0f172a; --panel:#111827; --panel-2:#1f2937; --text:#e5e7eb; --muted:#9ca3af;
      --brand:#22c55e; --brand-2:#16a34a; --error:#ef4444; --focus:#93c5fd;
      --ring: 2px solid var(--focus);
    }
    /* Tema claro */
    [data-theme="light"]{
      --bg:#f5f7fb; --panel:#ffffff; --panel-2:#eef1f7; --text:#111827; --muted:#6b7280;
      --brand:#16a34a; --brand-2:#22c55e; --error:#dc2626; --focus:#2563eb;
    }

    *{box-sizing:border-box}
    :focus-visible{outline: var(--ring); outline-offset: 3px}

    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 600px at 20% -10%, #1e293b22, transparent), var(--bg);
      color:var(--text);
      line-height:1.4;
      min-height:100dvh;
      display:flex; align-items:flex-start; justify-content:center;
      padding:24px 16px 96px;
    }

    .app{
      width:min(1100px, 100%);
      background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
      border:1px solid var(--panel-2);
      border-radius:16px;
      padding:22px;
      box-shadow: 0 10px 30px rgba(0,0,0,.20), inset 0 1px 0 rgba(255,255,255,.06);

      /* Compat Safari/iOS para blur + fallback */
      -webkit-backdrop-filter: saturate(180%) blur(12px);
      backdrop-filter: saturate(180%) blur(12px);
      background-clip: padding-box;
    }
    @supports not ((-webkit-backdrop-filter: blur(0)) or (backdrop-filter: blur(0))){
      .app{ background: var(--panel); }
    }

    header{
      display:flex; gap:14px; align-items:center; justify-content:space-between; margin-bottom:14px;
      flex-wrap:wrap;
    }
    h1{font-size:clamp(20px, 3vw, 28px); margin:0;}
    .sub{color:var(--muted); font-size:.95rem}

    .row{display:grid; grid-template-columns: 1fr; gap:14px; margin-top:14px;}
    @media (min-width:920px){
      .row.two{grid-template-columns: 1.1fr 1fr;}
      .row.three{grid-template-columns: 1fr 1fr 1fr;}
      .row.layout{grid-template-columns: 1fr 1.3fr;}
    }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
      border:1px solid var(--panel-2);
      border-radius:12px;
      padding:14px;
    }

    .toolbar{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .kicker{font-size:12px; color:var(--muted); text-transform:uppercase; letter-spacing:.6px}
    .muted{color:var(--muted)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}

    .field{
      display:flex; align-items:center; gap:10px;
      border:1px solid var(--panel-2); border-radius:10px; padding:10px 12px;
      background:var(--panel);
    }
    label{display:block; font-weight:600; margin-bottom:6px;}
    .hint{font-size:.85rem; color:var(--muted); margin-top:4px}

    .segmented{
      display:flex; background:var(--panel); border:1px solid var(--panel-2); border-radius:10px; padding:6px; gap:6px;
    }
    .segmented input{display:none}
    .segmented label{
      flex:1; text-align:center; padding:10px 8px; border-radius:8px; cursor:pointer; user-select:none;
      border:1px solid transparent; font-weight:600;
    }
    .segmented input:checked + label{
      background: var(--brand); color:#052e16; border-color:transparent;
    }

    .units{display:flex; gap:8px; align-items:center;}
    .btn{
      appearance:none; padding:10px 14px; border-radius:10px; border:1px solid var(--panel-2);
      background:linear-gradient(180deg, var(--brand), var(--brand-2)); color:#052e16; font-weight:800; cursor:pointer;
    }
    .btn.secondary{ background:var(--panel); color:var(--text); border:1px solid var(--panel-2); }
    .btn.ghost{ background:transparent; color:var(--text); }

    .result{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      background:var(--panel); border:1px solid var(--panel-2); border-radius:12px; padding:14px;
    }
    .result h2{margin:0; font-size:1.3rem}
    .error{color:var(--error); font-weight:600}

    .grid-two{display:grid; grid-template-columns:1fr; gap:10px}
    @media (min-width:700px){ .grid-two{grid-template-columns:1fr 1fr;} }

    table{width:100%; border-collapse:collapse; font-size:14px}
    th, td{padding:8px 6px; border-bottom:1px solid var(--panel-2); text-align:left}
    th{font-size:12px; color:var(--muted); text-transform:uppercase; letter-spacing:.5px}

    /* Banner de actualización */
    .update-banner{
      position:fixed; left:12px; right:12px; bottom:12px; z-index:50;
      display:none; gap:10px; align-items:center; justify-content:space-between;
      background:var(--panel); color:var(--text); border:1px solid var(--panel-2); border-radius:12px; padding:10px 12px;
      box-shadow:0 10px 30px rgba(0,0,0,.25);
    }

    /* Toggle tema */
    .theme-toggle{display:flex; gap:6px; align-items:center}
    .kbd{padding:2px 6px; border:1px solid var(--panel-2); border-radius:6px; background:var(--panel); font-family:inherit; font-size:12px}
  </style>
</head>
<body>
  <div class="app" role="application" aria-label="Calculadora de ritmo, tiempo y distancia para correr">
    <header>
      <div>
        <h1>Calculadora de carrera</h1>
        <div class="sub">Instalable (PWA), proyecciones, ajuste por desnivel y zonas de FC/ritmo.</div>
      </div>
      <div class="toolbar">
        <div class="units" role="group" aria-label="Unidades">
          <span class="muted">Unidades:</span>
          <button id="kmBtn" class="btn secondary" aria-pressed="true">km</button>
          <button id="miBtn" class="btn secondary" aria-pressed="false">mi</button>
        </div>
        <div class="theme-toggle">
          <span class="muted">Tema:</span>
          <button id="themeAuto" class="btn secondary">Auto</button>
          <button id="themeLight" class="btn secondary">Claro</button>
          <button id="themeDark" class="btn secondary">Oscuro</button>
        </div>
      </div>
    </header>

    <div class="row layout">
      <section class="card">
        <div class="segmented" role="tablist" aria-label="Modo de cálculo">
          <input type="radio" id="modo-tiempo" name="modo" value="time" checked><label for="modo-tiempo" role="tab">Calcular <u>Tiempo</u></label>
          <input type="radio" id="modo-ritmo" name="modo" value="pace"><label for="modo-ritmo" role="tab">Calcular <u>Ritmo</u></label>
          <input type="radio" id="modo-dist" name="modo" value="distance"><label for="modo-dist" role="tab">Calcular <u>Distancia</u></label>
        </div>

        <div class="grid-two" style="margin-top:14px">
          <div>
            <label for="distance">Distancia</label>
            <div class="field">
              <input id="distance" type="number" inputmode="decimal" step="0.01" min="0" placeholder="9.70">
              <span id="unitDistance" class="muted">km</span>
            </div>
            <div class="hint">Ej.: 5, 9.7, 21.097, 42.195</div>
          </div>
          <div id="paceBlock">
            <label for="pace">Ritmo</label>
            <div class="field">
              <input id="pace" type="text" inputmode="numeric" placeholder="mm:ss (p. ej. 4:40)" aria-describedby="paceHint">
              <span id="unitPace" class="muted">/km</span>
            </div>
            <div id="paceHint" class="hint">Formato mm:ss (o hh:mm:ss). También “m'ss” (4'40).</div>
          </div>
          <div id="timeBlock">
            <label for="time">Tiempo</label>
            <div class="field">
              <input id="time" type="text" inputmode="numeric" placeholder="hh:mm:ss (p. ej. 00:45:16)" aria-describedby="timeHint">
            </div>
            <div id="timeHint" class="hint">Formato hh:mm:ss (o mm:ss). Ej.: 45:16</div>
          </div>
        </div>

        <div class="grid-two" style="margin-top:8px">
          <div>
            <div class="kicker">Ajuste por desnivel (simple)</div>
            <div class="field">
              <label for="grade" class="muted" style="margin:0;min-width:160px">Pendiente media (%)</label>
              <input id="grade" type="number" inputmode="decimal" step="0.5" min="-15" max="15" value="0" style="max-width:140px">
              <select id="terrain" class="mono" style="max-width:180px">
                <option value="road" selected>Asfalto</option>
                <option value="trail_mod">Trail moderado</option>
                <option value="trail_tech">Trail técnico</option>
              </select>
            </div>
            <div class="hint">Aproximado: +12 s/km por +1% subida (−8 s/km por −1% bajada). Trail añade penalización por técnica.</div>
          </div>

          <div class="toolbar">
            <button id="swap" class="btn secondary" title="Intercambiar tiempo ↔ ritmo">Intercambiar</button>
            <button id="reset" class="btn secondary" title="Borrar (Esc)"><span class="kbd">Esc</span> Borrar</button>
            <button id="calc" class="btn" title="Calcular (Enter)"><span class="kbd">Enter</span> Calcular</button>
          </div>
        </div>
      </section>

      <section class="card">
        <div class="result" role="status" aria-live="polite">
          <div>
            <h2 id="mainResult" class="mono">—</h2>
            <div class="muted" id="subResult"></div>
          </div>
          <div class="toolbar">
            <button id="share" class="btn secondary">Compartir</button>
            <button id="copy" class="btn secondary">Copiar</button>
            <button id="install" class="btn secondary" style="display:none">Instalar</button>
          </div>
        </div>
        <div class="hint" style="margin-top:8px">
          Atajos: <span class="kbd">Enter</span> calcular · <span class="kbd">Esc</span> limpiar · <span class="kbd">Alt+1</span> Tiempo · <span class="kbd">Alt+2</span> Ritmo · <span class="kbd">Alt+3</span> Distancia
        </div>
      </section>
    </div>

    <div class="row two">
      <!-- Proyecciones -->
      <section class="card">
        <div class="kicker">Proyección de tiempos (5K · 10K · 21K · 42K)</div>
        <div class="toolbar" style="margin:6px 0 10px">
          <label class="muted">Modelo:</label>
          <select id="projectionModel">
            <option value="linear" selected>Lineal (ritmo constante)</option>
            <option value="riegel">Riegel (exponente 1.06)</option>
          </select>
          <span class="muted">Usa tus datos actuales (distancia+ritmo o distancia+tiempo).</span>
        </div>
        <div style="overflow:auto">
          <table id="projTable">
            <thead>
              <tr><th>Prueba</th><th>Tiempo</th><th>Tiempo (ajustado desnivel)</th></tr>
            </thead>
            <tbody>
              <tr><td>5 km</td><td class="mono" data-k="5">—</td><td class="mono" data-ka="5">—</td></tr>
              <tr><td>10 km</td><td class="mono" data-k="10">—</td><td class="mono" data-ka="10">—</td></tr>
              <tr><td>Media (21.097)</td><td class="mono" data-k="21.097">—</td><td class="mono" data-ka="21.097">—</td></tr>
              <tr><td>Maratón (42.195)</td><td class="mono" data-k="42.195">—</td><td class="mono" data-ka="42.195">—</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- Zonas -->
      <section class="card">
        <div class="kicker">Zonas (elige método)</div>
        <div class="segmented" role="tablist" aria-label="Zonas">
          <input type="radio" id="zones-hr" name="zones" value="hr" checked><label for="zones-hr">Por FC</label>
          <input type="radio" id="zones-pace" name="zones" value="pace"><label for="zones-pace">Por ritmo umbral</label>
        </div>

        <div id="zonesHR" class="grid-two" style="margin-top:10px">
          <div class="field">
            <label for="hrMax" style="margin:0;min-width:120px">FC Máx</label>
            <input id="hrMax" type="number" inputmode="numeric" placeholder="190">
          </div>
          <div class="field">
            <label for="hrRest" style="margin:0;min-width:120px">FC Reposo (opcional)</label>
            <input id="hrRest" type="number" inputmode="numeric" placeholder="60">
          </div>
          <div style="grid-column:1/-1">
            <table>
              <thead><tr><th>Zona</th><th>% FCmáx</th><th>BPM</th></tr></thead>
              <tbody id="zonesHRBody">
                <!-- Relleno vía JS -->
              </tbody>
            </table>
          </div>
        </div>

        <div id="zonesPace" class="grid-two" style="margin-top:10px; display:none">
          <div class="field">
            <label for="ltPace" style="margin:0;min-width:160px">Ritmo umbral (mm:ss / km)</label>
            <input id="ltPace" type="text" inputmode="numeric" placeholder="4:10">
          </div>
          <div style="grid-column:1/-1">
            <table>
              <thead><tr><th>Zona</th><th>Rango (min/km)</th></tr></thead>
              <tbody id="zonesPaceBody">
                <!-- Relleno vía JS -->
              </tbody>
            </table>
          </div>
        </div>
      </section>
    </div>

    <div class="update-banner" id="updateBanner" role="status" aria-live="polite">
      <div>Nueva versión disponible.</div>
      <div class="toolbar">
        <button id="refresh" class="btn">Actualizar</button>
        <button id="dismiss" class="btn secondary">Luego</button>
      </div>
    </div>
  </div>

<script>
(function(){
  const $ = (id) => document.getElementById(id);

  // ---------- Estado / preferencias ----------
  const state = {
    units: localStorage.getItem('units') || 'km',
    theme: localStorage.getItem('theme') || 'auto', // auto|light|dark
    roundMode: 'none'
  };

  function applyTheme(t){
    document.documentElement.setAttribute('data-theme', t === 'auto'
      ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark':'light')
      : t
    );
    localStorage.setItem('theme', t);
  }

  // ---------- Utilidades numéricas / tiempo ----------
  const KM_PER_MI = 1.609344;

  function sanitizeNumber(v){ return (typeof v === 'string' ? v.replace(',', '.').trim() : v); }
  function parseDistance(value){ const v = parseFloat(sanitizeNumber(value)); return (Number.isFinite(v) && v > 0) ? v : NaN; }

  function parseHMS(str){
    if(!str) return NaN;
    str = str.trim().toLowerCase().replace(/h/g,':').replace(/m/g,':').replace(/s/g,'').replace(/'+/g,':');
    const parts = str.split(':').filter(Boolean).map(p => p.trim());
    if(parts.length === 1){
      const num = parseFloat(sanitizeNumber(parts[0])); if(!Number.isFinite(num)) return NaN; return (num > 10 ? num*60 : num);
    }
    if(parts.length === 2){
      const mm = parseFloat(sanitizeNumber(parts[0])); const ss = parseFloat(sanitizeNumber(parts[1]));
      if(!Number.isFinite(mm) || !Number.isFinite(ss) || ss>=60) return NaN; return Math.round(mm*60+ss);
    }
    if(parts.length === 3){
      const hh = parseFloat(sanitizeNumber(parts[0])); const mm = parseFloat(sanitizeNumber(parts[1])); const ss = parseFloat(sanitizeNumber(parts[2]));
      if([hh,mm,ss].some(x=>!Number.isFinite(x)) || mm>=60 || ss>=60) return NaN; return Math.round(hh*3600+mm*60+ss);
    }
    return NaN;
  }

  function formatHMS(totalSeconds){
    if(!Number.isFinite(totalSeconds)) return '—';
    totalSeconds = Math.round(totalSeconds);
    const sign = totalSeconds < 0 ? '-' : '';
    totalSeconds = Math.abs(totalSeconds);
    const hh = Math.floor(totalSeconds / 3600);
    const mm = Math.floor((totalSeconds % 3600) / 60);
    const ss = totalSeconds % 60;
    const pad = n => String(n).padStart(2,'0');
    return (hh>0 ? `${sign}${pad(hh)}:${pad(mm)}:${pad(ss)}` : `${sign}${pad(mm)}:${pad(ss)}`);
  }

  function currentUnitLabel(){ return state.units==='km' ? '/km' : '/mi'; }
  function speedFromPace(secPerUnit){ const hours = secPerUnit/3600; return 1/hours; }

  // Ajuste por desnivel (muy aproximado)
  function adjustedPaceSec(paceSec, gradePct, terrain){
    const g = parseFloat(gradePct)||0;
    let delta = (g >= 0) ? (g * 12) : (g * 8); // s/km por %
    // Penalización técnica
    if(terrain === 'trail_mod') delta += 20;
    if(terrain === 'trail_tech') delta += 40;
    return Math.max(1, paceSec + delta);
  }

  // ---------- Elementos ----------
  const distance = $('distance');
  const pace = $('pace');
  const time = $('time');
  const unitDistance = $('unitDistance');
  const unitPace = $('unitPace');
  const mainResult = $('mainResult');
  const subResult = $('subResult');
  const kmBtn = $('kmBtn');
  const miBtn = $('miBtn');
  const calcBtn = $('calc');
  const resetBtn = $('reset');
  const swapBtn = $('swap');
  const shareBtn = $('share');
  const copyBtn = $('copy');
  const gradeEl = $('grade');
  const terrainEl = $('terrain');

  // Proyección
  const projectionModel = $('projectionModel');

  // Zonas
  const zonesHRRadio = $('zones-hr');
  const zonesPaceRadio = $('zones-pace');
  const zonesHR = $('zonesHR');
  const zonesPace = $('zonesPace');
  const hrMax = $('hrMax'); const hrRest = $('hrRest');
  const zonesHRBody = $('zonesHRBody');
  const ltPace = $('ltPace'); const zonesPaceBody = $('zonesPaceBody');

  // Tema
  $('themeAuto').onclick = () => { state.theme='auto'; applyTheme('auto'); };
  $('themeLight').onclick = () => { state.theme='light'; applyTheme('light'); };
  $('themeDark').onclick = () => { state.theme='dark'; applyTheme('dark'); };

  // ---------- Modo y visibilidad ----------
  function getMode(){
    return $('modo-tiempo').checked ? 'time' : ($('modo-ritmo').checked ? 'pace' : 'distance');
  }
  function updateVisibility(){
    $('paceBlock').style.display = (getMode()==='pace') ? 'none' : '';
    $('timeBlock').style.display = (getMode()==='time') ? 'none' : '';
  }

  // ---------- Cálculos base ----------
  function compute(){
    clearError();
    const mode = getMode();
    const d = parseDistance(distance.value);
    const p = parseHMS(pace.value);
    const t = parseHMS(time.value);
    const grade = parseFloat(gradeEl.value) || 0;
    const terr = terrainEl.value;

    try{
      if(mode==='time'){
        if(!Number.isFinite(d) || !Number.isFinite(p)) throw new Error('Necesitas distancia y ritmo.');
        const timeSec = Math.round(d * adjustedPaceSec(p, grade, terr));
        const baseTime = Math.round(d * p);
        showTimeResult(timeSec, p, baseTime);
      }else if(mode==='pace'){
        if(!Number.isFinite(d) || !Number.isFinite(t)) throw new Error('Necesitas distancia y tiempo.');
        const paceSecBase = t / d;
        const paceAdj = adjustedPaceSec(paceSecBase, grade, terr);
        showPaceResult(paceAdj, t, paceSecBase);
      }else{
        if(!Number.isFinite(t) || !Number.isFinite(p)) throw new Error('Necesitas tiempo y ritmo.');
        const dist = t / p; // base sin desnivel
        const distAdj = t / adjustedPaceSec(p, grade, terr);
        showDistanceResult(distAdj, p, t, dist);
      }
    }catch(err){
      showError(err.message||String(err));
    }
    updateProjections(); // rellena tabla con datos actuales
  }

  function showTimeResult(timeAdjSec, paceSecBase, timeBaseSec){
    mainResult.textContent = `Tiempo: ${formatHMS(timeAdjSec)}`;
    const spd = speedFromPace(paceSecBase);
    subResult.innerHTML = `Ritmo base: <span class="mono">${formatHMS(paceSecBase)} ${currentUnitLabel()}</span> • Velocidad: <span class="mono">${spd.toFixed(2)} ${state.units}/h</span>${timeBaseSec?` • Tiempo base: <span class="mono">${formatHMS(timeBaseSec)}</span>`:''}`;
  }
  function showPaceResult(paceAdjSec, timeSec, paceBaseSec){
    mainResult.textContent = `Ritmo (ajustado): ${formatHMS(paceAdjSec)} ${currentUnitLabel()}`;
    const spd = speedFromPace(paceBaseSec);
    subResult.innerHTML = `Tiempo: <span class="mono">${formatHMS(timeSec)}</span> • Ritmo base: <span class="mono">${formatHMS(paceBaseSec)} ${currentUnitLabel()}</span> • Velocidad base: <span class="mono">${spd.toFixed(2)} ${state.units}/h</span>`;
  }
  function showDistanceResult(distAdj, paceSecBase, timeSec, distBase){
    mainResult.textContent = `Distancia (ajustada): ${distAdj.toFixed(2)} ${state.units}`;
    const spd = speedFromPace(paceSecBase);
    subResult.innerHTML = `Distancia base: <span class="mono">${(distBase||0).toFixed(2)} ${state.units}</span> • Ritmo base: <span class="mono">${formatHMS(paceSecBase)} ${currentUnitLabel()}</span> • Tiempo: <span class="mono">${formatHMS(timeSec)}</span> • Velocidad base: <span class="mono">${spd.toFixed(2)} ${state.units}/h</span>`;
  }

  function clearError(){ subResult.classList.remove('error'); }
  function showError(msg){ mainResult.textContent='—'; subResult.textContent=msg; subResult.classList.add('error'); }

  // ---------- Proyecciones ----------
  const raceList = [5, 10, 21.097, 42.195];
  function updateProjections(){
    const d0 = parseDistance(distance.value);
    let pSec = parseHMS(pace.value);
    let t0 = parseHMS(time.value);

    // Derivar base
    if(!Number.isFinite(pSec) && Number.isFinite(d0) && Number.isFinite(t0)) pSec = t0/d0;
    if(!Number.isFinite(d0) && Number.isFinite(pSec) && Number.isFinite(t0)) { /* no d0 → no Riegel */ }

    const model = projectionModel.value;
    const grade = parseFloat(gradeEl.value)||0;
    const terr = terrainEl.value;

    const cells = document.querySelectorAll('#projTable [data-k]');
    cells.forEach(td=>{
      const k = parseFloat(td.getAttribute('data-k'));
      let timeSec = NaN;

      if(model==='linear' && Number.isFinite(pSec)){
        timeSec = k * pSec;
      }else if(model==='riegel' && Number.isFinite(d0) && Number.isFinite(t0)){
        timeSec = t0 * Math.pow(k/d0, 1.06);
      }

      td.textContent = Number.isFinite(timeSec) ? formatHMS(timeSec) : '—';

      // Ajustado por desnivel (aplica al ritmo, luego multiplica)
      const adjTd = document.querySelector(`#projTable [data-ka="${k}"]`);
      if(Number.isFinite(pSec)){
        const paceAdj = adjustedPaceSec(pSec, grade, terr);
        const tAdjLinear = k * paceAdj;
        if(model==='linear'){
          adjTd.textContent = formatHMS(tAdjLinear);
        }else if(model==='riegel' && Number.isFinite(d0) && Number.isFinite(t0)){
          // Para Riegel, aplicamos el ajuste al tiempo base equivalente
          const baseLinear = k * pSec;
          const factor = tAdjLinear / (k*pSec); // relación por ajuste
          adjTd.textContent = formatHMS((t0 * Math.pow(k/d0, 1.06)) * factor);
        }else{
          adjTd.textContent = '—';
        }
      }else{
        adjTd.textContent = '—';
      }
    });
  }

  // ---------- Zonas ----------
  function renderHRZones(){
    const max = parseInt(hrMax.value,10);
    const rest = parseInt(hrRest.value,10) || null;

    const zones = [
      {name:'Z1 Recuperación', lo:50, hi:60},
      {name:'Z2 Aeróbica',     lo:60, hi:70},
      {name:'Z3 Tempo',        lo:70, hi:80},
      {name:'Z4 Umbral/VO₂',   lo:80, hi:90},
      {name:'Z5 Máxima',       lo:90, hi:100}
    ];

    zonesHRBody.innerHTML = '';
    if(!Number.isFinite(max)){ zonesHRBody.innerHTML = '<tr><td colspan="3" class="muted">Introduce tu FC máx.</td></tr>'; return; }

    zones.forEach(z=>{
      const bpmLo = Math.round(max * z.lo/100);
      const bpmHi = Math.round(max * z.hi/100);
      zonesHRBody.insertAdjacentHTML('beforeend',
        `<tr><td>${z.name}</td><td>${z.lo}–${z.hi}%</td><td>${bpmLo}${rest?` (${bpmLo-rest} rsv)`:''}–${bpmHi}${rest?` (${bpmHi-rest} rsv)`:''}</td></tr>`);
    });
  }

  function renderPaceZones(){
    const p = parseHMS(ltPace.value);
    zonesPaceBody.innerHTML = '';
    if(!Number.isFinite(p)){ zonesPaceBody.innerHTML = '<tr><td colspan="2" class="muted">Introduce tu ritmo umbral (min/km).</td></tr>'; return; }

    // Multiplicadores aproximados sobre el RITMO umbral (valores típicos orientativos)
    const bands = [
      {name:'Z1 Recuperación', lo:1.17, hi:1.35}, // más lento
      {name:'Z2 Aeróbica',     lo:1.07, hi:1.17},
      {name:'Z3 Tempo/Umbral', lo:0.95, hi:1.05}, // alrededor del umbral
      {name:'Z4 Intervalo',    lo:0.88, hi:0.95}, // más rápido
      {name:'Z5 Repeticiones', lo:0.80, hi:0.88}  // muy rápido
    ];

    bands.forEach(b=>{
      const lo = Math.max(1, Math.round(p * b.lo));
      const hi = Math.max(1, Math.round(p * b.hi));
      // Para mostrar rango “lento–rápido” en min/km (número mayor = más lento)
      const lowStr = formatHMS(Math.max(lo,hi));
      const highStr = formatHMS(Math.min(lo,hi));
      zonesPaceBody.insertAdjacentHTML('beforeend',
        `<tr><td>${b.name}</td><td>${lowStr} – ${highStr}</td></tr>`);
    });
  }

  // ---------- Unidades / tema ----------
  function setUnits(u){
    state.units = u;
    unitDistance.textContent = u;
    unitPace.textContent = (u==='km' ? '/km' : '/mi');
    kmBtn.setAttribute('aria-pressed', u==='km' ? 'true':'false');
    miBtn.setAttribute('aria-pressed', u==='mi' ? 'true':'false');
    localStorage.setItem('units', u);
  }

  // ---------- Eventos ----------
  kmBtn.addEventListener('click', () => setUnits('km'));
  miBtn.addEventListener('click', () => setUnits('mi'));

  document.querySelectorAll('input[name="modo"]').forEach(r => {
    r.addEventListener('change', () => { updateVisibility(); compute(); });
  });

  calcBtn.addEventListener('click', compute);

  [distance, pace, time, gradeEl, terrainEl, projectionModel].forEach(inp => {
    inp.addEventListener('input', () => { /* live */ });
    inp.addEventListener('change', () => { compute(); });
  });

  // Atajos de teclado
  document.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter') { e.preventDefault(); calcBtn.click(); }
    if(e.key === 'Escape'){ e.preventDefault(); resetBtn.click(); }
    if(e.altKey && e.key==='1'){ $('modo-tiempo').checked = true; updateVisibility(); }
    if(e.altKey && e.key==='2'){ $('modo-ritmo').checked = true; updateVisibility(); }
    if(e.altKey && e.key==='3'){ $('modo-dist').checked = true; updateVisibility(); }
  });

  swapBtn.addEventListener('click', () => { const a = pace.value; pace.value = time.value; time.value = a; });
  resetBtn.addEventListener('click', () => {
    distance.value=''; pace.value=''; time.value=''; mainResult.textContent='—'; subResult.textContent=''; compute();
  });

  copyBtn.addEventListener('click', async () => {
    const text = `${mainResult.textContent} (${subResult.textContent})`;
    try{ await navigator.clipboard.writeText(text); copyBtn.textContent='Copiado ✓'; setTimeout(()=>copyBtn.textContent='Copiar', 1200); }catch{}
  });

  shareBtn.addEventListener('click', async () => {
    const data = { title: 'Resultado calculadora', text: `${mainResult.textContent} (${subResult.textContent})`, url: location.href };
    try{
      if(navigator.share){ await navigator.share(data); }
      else { await navigator.clipboard.writeText(`${data.text} ${data.url}`); alert('Compartido (copiado al portapapeles).'); }
    }catch{}
  });

  zonesHRRadio.addEventListener('change', ()=>{ zonesHR.style.display='grid'; zonesPace.style.display='none'; });
  zonesPaceRadio.addEventListener('change', ()=>{ zonesHR.style.display='none'; zonesPace.style.display='grid'; });
  [hrMax, hrRest].forEach(i=> i.addEventListener('input', renderHRZones));
  ltPace.addEventListener('input', renderPaceZones);

  // ---------- Inicialización ----------
  // Preferencias
  setUnits(state.units);
  applyTheme(state.theme);
  updateVisibility();

  // Ejemplo precargado
  distance.value = '9.70';
  pace.value='4:40';
  compute();
  renderHRZones();
  renderPaceZones();

  // ---------- Manifest (con iconos maskable) ----------
  (function injectManifest(){
    const manifest = {
      name: "Calculadora de carrera",
      short_name: "CarreraCalc",
      start_url: "./index.html",
      scope: "./",
      display: "standalone",
      background_color: getComputedStyle(document.documentElement).getPropertyValue('--bg').trim() || "#0f172a",
      theme_color: "#22c55e",
      icons: [
        { "src": "icons/icon-192.png", "sizes": "192x192", "type":"image/png", "purpose":"any maskable" },
        { "src": "icons/icon-512.png", "sizes": "512x512", "type":"image/png", "purpose":"any maskable" }
      ],
      shortcuts: [
        { "name":"Calcular tiempo", "short_name":"Tiempo", "url":"./?mode=time", "icons":[{"src":"icons/icon-192.png","sizes":"192x192"}] },
        { "name":"Calcular ritmo", "short_name":"Ritmo", "url":"./?mode=pace", "icons":[{"src":"icons/icon-192.png","sizes":"192x192"}] },
        { "name":"Calcular distancia", "short_name":"Distancia", "url":"./?mode=distance", "icons":[{"src":"icons/icon-192.png","sizes":"192x192"}] }
      ]
    };
    const blob = new Blob([JSON.stringify(manifest)], {type:'application/manifest+json'});
    const url = URL.createObjectURL(blob);
    document.getElementById('manifestLink').setAttribute('href', url);
  })();

  // ---------- Service Worker + aviso de actualización ----------
  const banner = $('updateBanner');
  const btnRefresh = $('refresh');
  const btnDismiss = $('dismiss');

  let newWorker;
  btnRefresh.addEventListener('click', ()=>{
    if(newWorker){ newWorker.postMessage({type:'SKIP_WAITING'}); }
  });
  btnDismiss.addEventListener('click', ()=> banner.style.display='none');

  if('serviceWorker' in navigator){
    window.addEventListener('load', async ()=>{
      try{
        const reg = await navigator.serviceWorker.register('sw.js?v=3'); // v=3 para bust de cache
        reg.addEventListener('updatefound', ()=>{
          const installing = reg.installing;
          installing.addEventListener('statechange', ()=>{
            if(installing.state === 'installed' && navigator.serviceWorker.controller){
              newWorker = installing;
              banner.style.display = 'flex';
            }
          });
        });
        navigator.serviceWorker.addEventListener('controllerchange', ()=>{ window.location.reload(); });
      }catch(e){ console.warn('SW no registrado:', e); }
    });
  }

  // Deep link ?mode=time|pace|distance
  const params = new URLSearchParams(location.search);
  const modeParam = params.get('mode');
  if(modeParam){
    if(modeParam==='time') $('modo-tiempo').checked = true;
    if(modeParam==='pace') $('modo-ritmo').checked = true;
    if(modeParam==='distance') $('modo-dist').checked = true;
    updateVisibility();
  }
})();
</script>
</body>
</html>
